name: "Labeler: Predict Issue Labels"

on:
  # Only automatically predict area labels when issues are originally opened
  issues:
    types: opened

  # Allow dispatching the workflow via the Actions UI, specifying ranges of numbers
  workflow_dispatch:
    inputs:
      issue_numbers:
        description: "Issue Numbers (comma-separated list of ranges)"
        type: string
      model_cache_key:
        description: "The cache key suffix to use for loading the model"
        type: string
        required: true
        default: "LIVE"

env:
  MODEL_PATH: labeler-cache/issue-model.zip

jobs:
  predict-issues:
    # Do not run the workflow on forks outside the 'jeffhandley' org
    if: ${{ github.repository_owner == 'jeffhandley' && (inputs.issue_numbers || github.event.issue.number) }}
    permissions:
      issues: write

    runs-on: ubuntu-latest

    steps:
      - name: "Restore model from cache"
        id: restore-cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.MODEL_PATH }}
          key: ${{ env.MODEL_CACHE_KEY }}
          fail-on-cache-miss: true

      - name: "Run Predictor"
        uses: jeffhandley/issue-labeler/predict-issues@main
        with:
          issue_model: ${{ env.MODEL_PATH }}
          issue_numbers: ${{ inputs.issue_numbers || github.event.issue.number }}
          label_prefix: "area-"
          threshold: 0.40
          default_label: "needs-area-label"
